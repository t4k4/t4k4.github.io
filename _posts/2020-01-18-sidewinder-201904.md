---
layout:     post
title:      sidewinder analysis
date:       2020-01-18 23:57:34
summary:    sidewinder analysis.
categories: Malware Analysis
thumbnail: Malware Analysis
tags:
 - APT
 - SideWinder
---

<p>2019年4月份样本.</p>

<hr />


<h1>样本分析</h1>
<h2>样本标签</h2>
<p>样本共包括四个攻击载荷，分别是sample.docx，main.rtf，final.hta以及Duser.dll。</p>

<h2>攻击载荷</h2>
<h3>sample.docx</h3>
<p>攻击者通过钓鱼邮件投递sample.docx文档。该文档是一个掩饰文档，打开文档后会触发CVE-2017-0199，从远程地址下载main.RTF文件并执行。解压文档可以看到文档中包含外部恶意链接hTtp://www.punjabpolice.gov.pk.standingoperatingprocedureforemergencythreat.cdn-in[.]net/images/5491E413/-1/7384/89dfd89e/main.RTF（该链接已失效）。</p>

<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/1.png" width="906" height="322" layout="responsive" alt="docx文档中包含的恶意链接" class="mb3"></amp-img>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/2.png" width="740" height="502" layout="responsive" alt="掩饰文档内容" class="mb3"></amp-img>

<h3>main.RTF</h3>
<p>main.RTF运行后会触发CVE-2017-11882。从main.RTF中提取objdata，图中“BA 36”开始的内容是FontName字段，直到NULL刚好48字节，0x4226B4即为覆盖的返回地址。此段内容是一段shellcode，用于执行远程hta文件http://cdn-in[.]net/includes/b7199e61/-1/7384/35955a61/final（以下称为final.hta，链接已失效）。</p>

 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/3.png" width="622" height="168" layout="responsive" alt="OLE对象数据" class="mb3"></amp-img>

<p>使用调试器attach到EQNEDT32.EXE，定位到shellcode执行位置。溢出发生在函数sub_41160F内，执行到函数结束（0x411874）时，函数返回地址已被覆盖为0x4226B4，该地址指向ret指令，通过两次返回跳转到0x18F354，即shellcode。</p>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/4.png" width="524" height="501" layout="responsive" alt="" class="mb3"></amp-img>

<p>shellcode首先调用GlobalLock和OleUninitialize函数，然后获取并调用GetCommandLineW，得到当前命令行；接下来，对objdata中的字符串异或解密得到远程文件地址替换命令行；最后加载mshtml库，获取RunHTMLApplication函数地址并调用，运行final.hta。</p>

<h3>final.hta</h3>
<p>final.hta文件中是一段js代码，用于将credwiz.exe复制到C:\ProgramData\drvr\srvc2.0\目录下，并将Duser.dll释放到同一目录下。代码首先对一段字符串进行base64解码，然后进行反序列化，最后调用实例o中的work函数。查看解码后的内容发现，解码后的内容中包含一个pe文件，如图所示。将pe文件dump出来，发现这是一个.net编译的名为PreBotHta.dll的dll文件。</p>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/5.png" width="574" height="143" layout="responsive" alt="final.hta部分内容" class="mb3"></amp-img>

<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/6.png" width="613" height="194" layout="responsive" alt="" class="mb3"></amp-img>

<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/7.png" width="550" height="362" layout="responsive" alt="" class="mb3"></amp-img>
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/8.png" width="303" height="68" layout="responsive" alt="preBotHta类的初始化" class="mb3"></amp-img>

<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/9.png" width="687" height="346" layout="responsive" alt="work函数" class="mb3"></amp-img>
 
<p>work函数首先在SecurityCenter中检查三个反病毒引擎（360，avast，avg）是否存在，如果不存在，则将其他反病毒引擎发送至http://cdn-in[.]net/plugins/-1/7384/true/true/（以下简称avURL）；然后找到系统CommonApplicationData文件夹（通常为C:\ProgramData文件夹），将credwiz.exe复制到该文件夹的drvr\srvc2.0\目录下，然后将该目录下的credwiz.exe文件添加到注册表中，完成开机启动（Software\Microsoft\Windows\CurrentVersion\Run）；最后解码另外一段字符串，写入同一目录下的Duser.dll文件中，运行credwiz.exe。如果以上过程中发生错误，则在发送至avURL的内容中附上异常信息。</p>

<h3>Duser.dll</h3>
<p>Credwiz.exe为正常文件，运行Credwiz.exe时利用标准搜索路径加载同一目录下的恶意Duser.dll。查看dll的导出表，发现所有的导出函数都指向同一地址。从这一地址开始分析，Duser.dll首先调用sub_10001D60进行一部分初始化的工作，然后调用sub_10002798，使用http://www.microsoft.com测试网络是否连通，如果连通则向https://cdn-list[.]net/1SdYMUrbdAfpgSt3Gv13U8Jca6qOvI4I2Fa1zSCT/-1/7384/43e2a8fa/css发送GET请求，如果返回200，解密返回的数据，得到javascript脚本并执行，这个过程每隔十分钟进行一次。由于以上链接均已失效，分析时无法获取服务端发送的js脚本内容。</p>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/10.png" width="474" height="238" layout="responsive" alt="export地址均相同" class="mb3"></amp-img>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/11.png" width="508" height="306" layout="responsive" alt="发送GET请求并解密收到的数据" class="mb3"></amp-img>
 
<amp-img src="{{ site.baseurl }}assets/images/sidewinder201904/12.png" width="514" height="398" layout="responsive" alt="得到javascript脚本并运行" class="mb3"></amp-img>
